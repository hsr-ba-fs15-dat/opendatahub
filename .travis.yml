language: python

python:
  - 2.7

addons:
  postgresql: 9.3

env:
  global:
    - CI=true

install:
  - pip install pybuilder
  - npm install -g npm@latest
  - npm cache clean
  - npm install -g bower grunt-cli
  - npm install -g tsd@next
  - gem update --system
  - gem install compass

before_script:
  - psql -c "CREATE USER opendatahub WITH PASSWORD 'opendatahub';" -U postgres
  - psql -c 'CREATE DATABASE opendatahub;' -U postgres
  - psql -c 'GRANT ALL PRIVILEGES ON DATABASE opendatahub to opendatahub;' -U postgres
  - psql -c 'ALTER USER opendatahub CREATEDB;' -U postgres

script:
 - pyb -v

before_deploy:
 - git config --global user.email 'build@travis-ci.com'
 - git config --global user.name 'Tavis CI'
 - git add -f $TRAVIS_BUILD_DIR/src/main/webapp/dist $TRAVIS_BUILD_DIR/src/main/python/staticfiles
 - git commit -q -m 'deploy to heroku'
 - cd $TRAVIS_BUILD_DIR

deploy:
  provider: heroku
  strategy: git
  skip_cleanup: true
  api_key:
    secure: Qb2O3PviVvKvxUxDuxxz8bxbVniNHgBYJxCzDBpLC56d7i5/yiZX9X2sBrFvBhFyh2naidzp0s9EgoN3U2HISaoThzM8/075pIlTnI7dir6R1623ngv7+COXAqoFRNME0A6ghJhTIfxEnDdNrztfQ8WcnVXuNU37kWIHGYryiJk=
  app:
    master: opendatahub-hsr-dev
  run:
    - python $HOME/src/main/python/manage.py migrate --noinput
    - python $HOME/src/main/python/manage.py makemigrations --noinput

notifications:
  slack:
    on_failure: always
    on_success: change
    rooms:
      - opendatahub:kFUd9okBkUuXn6L66bB9w65f#webapp

