<style>
    .container {
        max-width: 1300px;
    }
</style>
<form name="form" class="form-horizontal" ng-controller="OdhQLController as vm">
    <fieldset>

        <div class="form-group" ng-class="{'has-error': form.name.$invalid && vm.submitted}">
            <label class="col-md-3 control-label" for="name">Name/Titel</label>

            <div class="col-md-9">
                <input id="name" name="name" type="text" placeholder="Name für odhSQL Snippet."
                       class="form-control input-md"
                       ng-model="snippet.name"
                       required>

                <div ng-messages="form.name.$error" ng-show="form.name.submitted">
                    <span class="help-block">
                        <div ng-message="required">Bitte geben Sie einen Namen an</div>
                    </span>
                </div>
            </div>
        </div>

        <!-- Textarea -->
        <div class="form-group" ng-class="{'has-error': form.description.$invalid && vm.submitted}">
            <label class="col-md-3 control-label" for="description">Beschreibung</label>

            <div class="col-md-9">
                <textarea class="form-control" id="description" name="description"
                          ng-model="snippet.description"
                          placeholder="z.B. Transformiert alle Vornamen zu Nachnamen"
                          required
                          rows="4"
                        ></textarea>

                <div ng-messages="form.description.$error" ng-show="vm.submitted">
                    <span class="help-block">
                        <div ng-message="required">Bitte geben Sie eine Beschreibung an</div>
                    </span>
                </div>

            </div>
        </div>
        <!-- /Textarea -->

        <div class="well" ng-repeat-start="group in vm.selected.items" ng-show="$index > 0">
            Wählen Sie die Verbindung zwischen diesen 2 Tabellen aus:
            <select
                    ng-options="opt as opt.label for opt in vm.joinOperations"
                    ng-model="vm.joinOperationsSelection[group.uniqueid]">
            </select>

            <select
                    ng-options="opt as opt.alias for opt in vm.selected.fields[vm.selected.items[$index - 1].uniqueid]"
                    ng-show="vm.joinOperationsSelection[group.uniqueid].label == 'JOIN'"
                    ng-model="vm.join_fields[group.uniqueid][vm.selected.items[$index - 1].uniqueid]">
            </select>
            <select
                    ng-options="opt as opt.alias for opt in vm.selected.fields[vm.selected.items[$index].uniqueid]"
                    ng-show="vm.joinOperationsSelection[group.uniqueid].label == 'JOIN'"
                    ng-model="vm.join_fields[group.uniqueid][vm.selected.items[$index].uniqueid]">
            </select>
        </div>
        <div class="well" ng-repeat-end="group in vm.selected.items">
            Wählen Sie die benötigten Felder aus (Klick) und wählen Sie den Tabellennamen:
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th ng-repeat="col in group.cols"
                            ng-class="vm.selected.fields[group.uniqueid].indexOf(col) > -1 ? 'selected': ''"
                                >
                            <input type="text" ng-model="col.alias"/>
                        </th>
                    </tr>
                    </thead>
                    <tr ng-repeat="row in group.preview.data | limitTo: 3">
                        <td ng-class="vm.selected.fields[group.uniqueid].indexOf(col) > -1 ? 'selected': ''"
                            ng-repeat="col in group.cols" ng-click="vm.addField(col, group)">
                            {{ row[col.name] | characters:25 :true }}
                        </td>
                    </tr>
                </table>
            </div>

            <a ng-click="vm.selected.remove(group)">Tabelle entfernen</a>
        </div>

        <table class="table" ng-table="vm.tableParams" show-filter="true">
            <tbody ng-repeat="group in $groups">
            <tr class="ng-table-group">
                <td colspan="{{ $columns.length }} ">
                    <a href="" ng-click="group.$hideRows = !group.$hideRows">
                        <span class="glyphicon"
                              ng-class="{ 'glyphicon-chevron-right': group.$hideRows, 'glyphicon-chevron-down': !group.$hideRows }"></span>
                        <strong>{{ group.data[0].document.name }}</strong>

                    </a>
                    <small>{{ group.data[0].document.description }}</small>
                </td>
            </tr>
            <tr ng-hide="group.$hideRows" ng-repeat="item in group.data">
                <td data-title="'Name'" filter="{ 'file_name': 'text' }">
                    <i ng-click="vm.selected.add(item);" class="fa fa-plus-circle"
                       ng-hide="vm.selected.items.indexOf(item) > -1"></i>
                    {{item.file_name}}
                </td>
                <td data-title="'Dateiformat'">
                    {{item.file_format}}
                </td>
            </tr>
            </tbody>
        </table>

        <!-- Textarea -->
        <div class="form-group" ng-class="{'has-error': form.description.$invalid && vm.submitted}">
            <label class="col-md-3 control-label" for="odhsqlinput">odhSQL Snippet <i
                    class="fa fa-question-circle"></i></label>

            <div class="col-md-9">
                <textarea class="form-control" id="odhsqlinput" name="description"
                          ng-model="vm.odhqlInput" rows="10"
                          ng-model-options="{ getterSetter: true }"
                          placeholder="SELECT x FROM y WHERE z is 123;"
                          required
                        ></textarea>

                <div ng-messages="form.description.$error" ng-show="vm.submitted">
                    <span class="help-block">
                        <div ng-message="required">Bitte geben Sie das odhSQL Snippet an.</div>
                    </span>
                </div>

            </div>
        </div>
        <!-- /Textarea -->


        <div class="form-group">
            <label class="col-md-4 control-label" for="add"></label>

            <div class="col-md-8">
                <button ng-click="vm.submit()" id="add" name="add" class="btn btn-primary pull-right">
                    Speichern
                </button>
                <button ng-click="vm.preview()" id="cancel" name="cancel" class="btn btn-info pull-right">
                    Vorschau
                </button>
            </div>
        </div>

        <div ng-show="vm.progress" class="col-md-offset-3 col-md-6">
            <progressbar class="progress-striped active" max="100"
                         value="offer.progress" type="info">
            </progressbar>
        </div>

    </fieldset>
    <h1>Resultat: </h1>

    <div class="row">
        <div class="col-md-12 table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th ng-repeat="col in vm.columns">{{ col }}</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="row in vm.rows | limitTo: 50">
                    <td ng-repeat="col in vm.columns">
                        {{ row[col] }}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</form>


