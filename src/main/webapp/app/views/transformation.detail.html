<div ng-controller="TransformationDetailController as vm">
    <odh-spinner show-while="doc.loading">
        <form name="form" class="form" ng-submit="vm.submit()">
            <h1>{{ vm.name }}</h1>

            <p>{{ vm.description }}</p>

            <p ng-show="vm.previewError">{{ vm.previewError }}</p>

            <div class="panel panel-default">
                <div class="panel-heading">
                    Vorschau
                </div>
                <div class="panel-body">

                    <odh-preview pkg="vm.pkg" query="vm.transformation" download="vm.downloadAs(format)"></odh-preview>

                </div>
            </div>

            <div class="panel panel-default clearfix" style="margin-top: 2em">
                <div class="panel-heading" ng-click="vm.showExpertPanel = !vm.showExpertPanel">
                    Advanced
                </div>
                <div class="panel-body" id="expertPanel" collapse="!vm.showExpertPanel">
                    <a ui-sref="transformation/help" target="_blank"><i class="fa fa-question-circle"></i></a>
                    <!-- Textarea -->
                    <alert ng-repeat="alert in vm.alerts" type="{{ alert.type }}" close="vm.closeAlert($index)">
                        <strong>{{ alert.title }}</strong>
                        {{ alert.msg }}
                    </alert>
                    <div class="form-group" ng-class="{'has-error': form.odhqlinput.$invalid && vm.submitted}">
                        <div ui-ace="{
                    useWrapMode : true,
                    showGutter: false,
                    mode: 'sql',
                    firstLineNumber: 5,
                    onLoad: vm.aceLoaded,

                    }" ng-model="vm.transformation"></div>
                        <div ng-messages="form.description.$error" ng-show="vm.submitted">
                        <span class="help-block">
                            <div ng-message="required">Bitte geben Sie die OdhQL Abfrage an.</div>
                        </span>
                        </div>

                    </div>
                    <!-- /Textarea -->
                    <div class="form-group">
                        <label class="col-md-1 control-label" for="add"></label>

                        <div class="col-md-11">
                            <button ng-show="vm.isAuthenticated()" id="add" name="add"
                                    class="btn btn-primary pull-right"
                                    ng-click="vm.duplicateTransformation()">
                                Klonen
                            </button>
                            <button ng-show="vm.allowDelete" id="add" name="add" class="btn btn-primary pull-right"
                                    ng-click="vm.saveTransformation()">
                                Speichern
                            </button>
                            <button ng-click="vm.preview()" type='button' class="btn btn-info pull-right">
                                Vorschau
                            </button>
                        </div>
                    </div>

                    <div ng-show="vm.progress" class="col-md-offset-3 col-md-6">
                        <progressbar class="progress-striped active" max="100"
                                     value="offer.progress" type="info">
                        </progressbar>
                    </div>
                    <div class="row">
                        <div class="col-md-6 table-responsive">
                            <h2>Geladene Tabellen</h2>
                            <odh-choose-transformation
                                    add-remove-table="vm.addRemoveTable(table)"
                                    check-table-selected="vm.checkTableSelected(table)"
                                    modal="true"
                                    modal-visible="false"
                                    modal-opener="'Tabelle laden'"
                                    ></odh-choose-transformation>

                            <div class="row">
                                <div class="col-md-12 table-responsive">
                                    <table class="table table-striped table-hover">
                                        <tr ng-repeat="table in vm.loadedTablesArray">
                                            <td data-title="'Name'">{{ table.name }}</td>
                                            <td data-title="'Meta'">{{ table.count }} Zeilen / {{ table.columns.length
                                                }}
                                                Spalten
                                            </td>
                                        </tr>

                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 table-responsive">
                            <h2>Benutzte Tabellen</h2>
                            <table class="table table-striped">
                                <tr>
                                    <th>Name in Transformation verwendet</th>
                                    <th>Ausgew√§hlte Tabelle</th>
                                </tr>
                                <tr ng-repeat="table in vm.usedTables">
                                    <td>
                                        {{ table.name }}[{{table.alias}}] {{ table.unique_name }}
                                    </td>
                                    <td><select ng-options="v.unique_name for v in vm.loadedTablesArray
                                | filterAlreadyAdded:{tables: vm.chosenTables, selected: vm.selected[table.name].unique_name}"
                                                ng-model="vm.selected[table.name]"
                                                ng-change="vm.generateNewTransformation()"></select></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </form>
        <div ng-if="vm.templateTransformation">
            <h3>Template: </h3>
            <pre>{{ vm.templateTransformation }}</pre>
        </div>
    </odh-spinner>
</div>